#!/usr/bin/env node
// NOTE: Slot and button index 3 and 5 are physically disconnected
const BUTTON_PINS = [7, 2, 0, 3, 4]
const SLOT_PINS = [21, 22, 23, 24, 25]
const MOTOR_PIN = 29

const products = [
  {name: 'Munkholm 0,33L', price: 20.0 },
  {name: 'Club Mate 0,5L', price: 35.0 },
  null,
  {name: 'Tuborg 0,33L', price: 35.0 },
  null
]

const buttons = require('../buttons.js')(BUTTON_PINS)
const vend = require('../motor.js')(MOTOR_PIN, SLOT_PINS)
const cardreader = require('../cardreader.js')()
const log = require('../logger.js')

function waitForCard () {
  log.info('Waiting for card')

  cardreader.once('card', (cardId) => {
    log.info('Waiting for product selection')

    // Act within 10 seconds or drop current action
    let cancelTimeoutId = setTimeout(function cancel () {
      cardreader.removeAllListeners()
      buttons.removeAllListeners()
      waitForCard()
    }, 10 * 1000)

    // Wait for a single button press
    buttons.once('pressed', (button) => {
      clearTimeout(cancelTimeoutId)

      const slot = button
      const item = products[slot]

      if (!item) {
        log.info(`No item in slot #${slot}. Not doing anything.`)
        return
      }

      log.info(`Vending '${item.name}' from slot ${slot}`)

      vend(slot, (err) => {
        if (err) {
          log.error('Failed to vend product')
          throw err
        }

        log.info(`Charged ${user.username} for ${item.name}!`)
        waitForCard()
      })
    })
  })
}

waitForCard()
